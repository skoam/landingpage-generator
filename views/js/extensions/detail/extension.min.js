view.actions={upload:{upload_image:function(h,a,f){if(!f){f="module"}a=a?"":"-cache";var e=h;var g=e.files;if(f=="module"){name=view.store.modules.selected.name+"-image_"+base.actions.manipulation.getLastNumberFromString(e.id)+a}else{if(f=="account"){name="account"}}if(g.length>0){var d=g[0];var c=new FileReader();var b=d.name.indexOf("jpg")!=-1?".jpg":"";b=d.name.indexOf("png")!=-1?".png":b;b=d.name.indexOf("jpeg")!=-1?".jpeg":b;c.onload=function(i){base.makeRequest("../api/upload_image.php","POST",{image:i.target.result,account:view.store.account,fileName:name+b},function(j){j=JSON.parse(j);if(f=="module"){document.getElementById(h.id.replace("value","preview")).src=j.text+"?"+base.randomID();document.getElementById(h.id.replace("value","file")).innerHTML=j.text;base.actions.manipulation.removeClass(h.id.replace("value","preview"),"hidden")}if(f=="account"){base.instances.$detail.$accountImage.src=j.text+"?"+base.randomID()}})};c.readAsDataURL(d)}},upload_generic_file:function(f,g){g=g?"":"-cache";var d=f;var e=d.files;if(e.length>0){var c=e[0];var b=new FileReader();var a=c.name.indexOf("css")!=-1?".css":"";b.onload=function(h){base.makeRequest("../api/upload_generic_file.php","POST",{file:h.target.result,account:view.store.account,fileName:view.store.modules.selected.name+"-file_"+base.actions.manipulation.getLastNumberFromString(d.id)+g+a},function(i){i=JSON.parse(i);document.getElementById(f.id.replace("value","file")).innerHTML=i.text})};b.readAsDataURL(c)}}}};view.commentManagement={init:function(){var a=base.managesCookies.addCookie("kamgmt_username",a).read();if(a){base.instances.$detail.$comments.$username.value=a}view.commentManagement.readCommentsFromStore();view.commentManagement.restoreStoredComments();view.commentManagement.activateAddComment()},addNewComment:function(a,d,c){a=a?a:base.instances.$detail.$comments.$body.value;d=d?d:base.instances.$detail.$comments.$header.value;c=c?c:base.instances.$detail.$comments.$username.value;if(!d){d="Comment"}if(!c){c="anonymous user"}else{base.managesCookies.addCookie("kamgmt_username",c).write()}var b={header:d+" ("+c+")",body:a,date:new Date().toString(),id:"C"+base.randomID()};base.instances.$detail.$comments.$header.value="";base.instances.$detail.$comments.$body.value="";view.store.comments[b.id]=b;view.commentManagement.addCommentAsHTML(b.id);view.commentManagement.saveComments()},removeComment:function(b){var a="delete-comment-"+b;base.actions.manipulation.addClass(a,"btn-danger");document.getElementById(a).value="confirm delete";document.getElementById(a).onclick=function(){$("#comment-"+b).hide("fade",200,function(){document.getElementById("comment-"+b).remove()});delete view.store.comments[b];view.commentManagement.saveComments()}},saveComments:function(){base.makeRequest("../api/save_comments.php","POST",{account:view.store.account,comments:base.actions.manipulation.utf8_to_b64(JSON.stringify(view.store.comments))},function(a){})},activateAddComment:function(){base.instances.$detail.$comments.$addCommentBtn.onclick=function(){if(!base.instances.$detail.$comments.$body.value){base.actions.effects.highlightById(base.instances.$detail.$comments.$body.id,"lightgrey",1000);return}view.commentManagement.addNewComment()}},readCommentsFromStore:function(){if(base.instances.$detail.$comments.$raw.innerHTML&&base.instances.$detail.$comments.$raw.innerHTML!="REPLACE_WITH_COMMENTS_RAW"){view.store.comments=JSON.parse(base.actions.manipulation.b64_to_utf8(base.instances.$detail.$comments.$raw.innerHTML))}},restoreStoredComments:function(){base.getSnippet("comment.html",function(a){for(var c in view.store.comments){if(view.store.comments.hasOwnProperty(c)){var b=view.commentManagement.parseCommentHTML(a,view.store.comments[c].id);base.instances.$detail.$comments.$list.innerHTML=b+base.instances.$detail.$comments.$list.innerHTML}}})},parseCommentHTML:function(a,b){a=a.replace(/REPLACE_WITH_COMMENT_ID/g,b);a=a.replace("REPLACE_WITH_COMMENT_HEADER",view.store.comments[b].header);a=a.replace("REPLACE_WITH_COMMENT_BODY",view.store.comments[b].body);a=a.replace("REPLACE_WITH_COMMENT_DATE",view.store.comments[b].date);return a},addCommentAsHTML:function(a){base.getSnippet("comment.html",function(b){b=view.commentManagement.parseCommentHTML(b,a);base.instances.$detail.$comments.$list.innerHTML=b+base.instances.$detail.$comments.$list.innerHTML;base.actions.effects.highlightById("comment-"+a,"#428bca",1000)})}};view.moduleManagement={init:function(){view.moduleManagement.calculateModulesContainerSize();view.moduleManagement.makeModulesSortable();view.moduleManagement.getModuleDataFromStore();view.moduleManagement.activateAddModuleButton();view.moduleManagement.activateGenerateLandingPage()},hasChangedSettings:false,campaignReminder:false,maxNumberOfModuleValues:15,maxNumberOfCSSValues:10,activateGenerateLandingPage:function(){$generate_landingpage=$(base.instances.$detail.$generate_landingpage);$generate_landingpage.unbind("click");$generate_landingpage.click(function(){base.instances.$detail.$generate_landingpage_label.innerHTML="<i class='fa fa-cog fa-spin'></i>";base.makeRequest("../api/generate_landingpage.php","POST",{account:view.store.account},function(a){a=JSON.parse(a);if(a.type=="success"){base.instances.$detail.$generate_landingpage_label.innerHTML=a.text;base.actions.manipulation.removeClass(base.instances.$detail.$generate_landingpage_label.id,"error");base.actions.manipulation.addClass(base.instances.$detail.$generate_landingpage_label.id,"success");$(base.instances.$detail.$generate_landingpage_label).effect("shake",{direction:"up",distance:2,times:2},400)}else{base.instances.$detail.$generate_landingpage_label.innerHTML=a.text;base.actions.manipulation.addClass(base.instances.$detail.$generate_landingpage_label.id,"error");base.actions.manipulation.removeClass(base.instances.$detail.$generate_landingpage_label.id,"success")}})})},activateAddModuleButton:function(){var b=base.instances.$detail.$modules;view.store.modules.dialogue=b.$add_module_dialogue.innerHTML;b.$add_module_dialogue.remove();function a(){base.updateInstances();var e=base.instances.$detail.$modules;var f=$("#"+e.$add_module.id);f.popover({container:"body",title:"Select a module",content:view.store.modules.dialogue,placement:"bottom",html:true})}function d(){base.updateInstances();var e=base.instances.$detail.$modules;var f=$("#"+e.$add_module.id);var g=$("[id^="+e.select_module_id+"]");g.unbind("change");g.click(function(){var h=$(this).val();g.val("none");$(this).val(h)});g.change(function(){var h=this.selectedOptions[0].innerHTML;if(h=="- None -"){base.actions.manipulation.addClass(e.$add.id,"hidden");e.$dialogue_module_name.innerHTML="";e.$dialogue_module_description.innerHTML="";return}var i=document.getElementById(h+"-description").innerHTML;e.$dialogue_module_name.innerHTML=h;e.$dialogue_module_description.innerHTML=i;e.$dialogue_module_preview.src="../resource/modules/"+h+"/preview.png";$(e.$dialogue_preview_wrapper).insertAfter($(this));view.store.modules.lastAdded.name=h;view.store.modules.lastAdded.description=i;base.actions.manipulation.removeClass(e.$add.id,"hidden")});$add=$("#"+e.$add.id);$add.unbind("click");$add.click(function(){f.popover("hide");f.on("hidden.bs.popover",function(){a();var h=$("#"+e.$add_module.id);h.click(d)});base.getSnippet("module.html",function(m){view.store.modules.lastAdded.originalName=view.store.modules.lastAdded.name;var j=$("[id*='panel-container-"+view.store.modules.lastAdded.originalName+"']");var h=0;for(var k=0;k<j.length;k++){var l=parseInt(j[k].id.replace(/^\D+/g,""),10);if(l!="NaN"&&l>h){h=l}}view.store.modules.lastAdded.name=view.store.modules.lastAdded.name+" "+(h+1);view.store.modules.active=view.store.modules.lastAdded;e.$container.innerHTML=e.$container.innerHTML+view.parseForKeywords(m);$(document.getElementById("panel-container-"+view.store.modules.lastAdded.name)).insertAfter(e.$container.children[0]);view.moduleManagement.hasChangedSettings=true;view.moduleManagement.showSaveChangesButton();view.moduleManagement.activateModuleBoxes();view.moduleManagement.scrollToModule(view.store.modules.lastAdded.name)})})}a();var c=$("#"+b.$add_module.id);c.click(d)},scrollToModule:function(a){$(document.getElementById("panel-description-"+a)).click()},saveModuleSettings:function(){if(!view.store.modules.selected.name){return}var m=base.instances.$detail.$module_settings;var d=2;var l=[];for(var e=0;e<view.moduleManagement.maxNumberOfModuleValues;e++){var b=e+1;l[e]=document.getElementById(view.store.modules.selected.name+"-value"+b);if(l[e]&&l[e].type=="file"){l[e]=document.getElementById(view.store.modules.selected.name+"-file"+b).innerHTML}else{if(l[e]){l[e]=l[e].value}else{l[e]=""}}}var g=[];for(e=0;e<view.moduleManagement.maxNumberOfCSSValues;e++){b=e+1;g[e]=document.getElementById(view.store.modules.selected.name+"-cssvalue"+b);if(g[e]&&g[e].type=="file"){g[e]=document.getElementById(view.store.modules.selected.name+"-cssvaluefile"+b).innerHTML}else{if(g[e]){g[e]=g[e].value}else{g[e]=""}}}var f=document.getElementById(view.store.modules.selected.name+"-value2");f=f?f.value:"";view.store.modules.selected.sortableOrder=[];var a=document.getElementById(view.store.modules.selected.name+"-sortable");if(a&&a.innerHTML=="true"){var h=$(document.getElementById(view.store.modules.selected.name+"-sortable-list"))[0];var j=h.children;for(var c=0;c<j.length;c++){view.store.modules.selected.sortableOrder.push(j[c].id.replace(view.store.modules.selected.name+"-sortable",""))}}else{view.store.modules.selected.sortable="no"}view.store.modules.settings[view.store.modules.selected.name]={settings:m.$data.innerHTML,value_1:l[0],value_2:l[1],value_3:l[2],value_4:l[3],value_5:l[4],value_6:l[5],value_7:l[6],value_8:l[7],value_9:l[8],value_10:l[9],value_11:l[10],value_12:l[11],value_13:l[12],value_14:l[13],value_15:l[14],css_value_1:g[0],css_value_2:g[1],css_value_3:g[2],css_value_4:g[3],css_value_5:g[4],css_value_6:g[5],css_value_7:g[6],css_value_8:g[7],css_value_9:g[8],css_value_10:g[9],originalName:view.store.modules.selected.originalName,sortable:view.store.modules.selected.sortable,sortableOrder:view.store.modules.selected.sortableOrder};if(view.moduleManagement.hasChangedSettings){view.moduleManagement.showSaveChangesButton()}},loadModuleSettings:function(){var e=base.instances.$detail.$module_settings;e.$data.innerHTML=view.store.modules.settings[view.store.modules.selected.name].settings;var d=view.store.modules.settings[view.store.modules.selected.name];var g=null;var a=null;for(var b=0;b<view.moduleManagement.maxNumberOfModuleValues;b++){var c=b+1;var f=document.getElementById(view.store.modules.selected.name+"-value"+c);if(f&&f.type=="file"){g=document.getElementById(view.store.modules.selected.name+"-preview"+c);if(g&&d["value_"+c]){g.src=d["value_"+c]+"?"+base.randomID();base.actions.manipulation.removeClass(g.id,"hidden")}a=document.getElementById(view.store.modules.selected.name+"-file"+c);if(a){a.innerHTML=d["value_"+c]}}else{if(f){f.value=d["value_"+c]}}}for(b=0;b<view.moduleManagement.maxNumberOfCSSValues;b++){c=b+1;f=document.getElementById(view.store.modules.selected.name+"-cssvalue"+c);if(f&&f.type=="file"){g=document.getElementById(view.store.modules.selected.name+"-csspreview"+c);if(g){g.src=d["css_value_"+c]+"?"+base.randomID()}a=document.getElementById(view.store.modules.selected.name+"-cssfile"+c);if(a){a.innerHTML=d["value_"+c]}}else{if(f){f.value=d["css_value_"+c]}}}view.moduleManagement.onSettingsShown()},showSaveChangesButton:function(){base.actions.manipulation.removeClass(base.instances.$detail.$save_changes_hint.id,"hidden");var a=$("#"+base.instances.$detail.$save_modules.id);a.unbind("click");a.click(function(){if(!view.moduleManagement.campaignReminder){view.moduleManagement.saveAllModules();view.moduleManagement.hideSaveChangesButton()}else{view.moduleManagement.closeModuleSettings();$(base.instances.$detail.$campaign_reminder_dialogue).modal();$(base.instances.$detail.$campaign_reminder_dialogue).on("shown.bs.modal",function(){var b=$("#update-campaign-and-save");if(b){b.click(function(){b.attr("disabled","disabled");campaignSettings=[];var h=0;var c=Object.keys(view.store.modules.settings);var d=[];for(var e=0;e<c.length;e++){if(c[e].indexOf("Campaign")!=-1){d.push(c[e])}}var f=setInterval(function(){var j=d[h];var i={};$(document.getElementById("panel-description-"+d[h])).click();setTimeout(function(){try{var r=document.getElementById(j+"-platform").innerHTML;i.platform=$(document.getElementById(j+r)).val();var p=document.getElementById(j+"-shopId").innerHTML;i.shopId=$(document.getElementById(j+p)).val();var o=document.getElementById(j+"-article").innerHTML;i.article=$(document.getElementById(j+o)).val();var n=document.getElementById(j+"-start").innerHTML;i.start=$(document.getElementById(j+n)).val();var l=document.getElementById(j+"-end").innerHTML;i.end=$(document.getElementById(j+l)).val();var q=document.getElementById(j+"-title").innerHTML;i.title=base.actions.manipulation.utf8_to_b64($(document.getElementById(j+q)).val());var u=document.getElementById(j+"-due").innerHTML;i.due=base.actions.manipulation.utf8_to_b64($(document.getElementById(j+u)).val());var m=document.getElementById(j+"-ended").innerHTML;i.ended=base.actions.manipulation.utf8_to_b64($(document.getElementById(j+m)).val());var t=document.getElementById(j+"-language").innerHTML;i.language=$(document.getElementById(j+t)).val();var k=document.getElementById(j+"-hideFullShopLayout").innerHTML;i.hideFullShopLayout=$(document.getElementById(j+k)).val();campaignSettings.push(i);$(document.getElementById("panel-description-"+d[h])).click();console.log(d[h]);if(h>=d.length){clearInterval(f)}else{h++}}catch(s){clearInterval(f)}},2000)},3000);var g=setInterval(function(){if(h>=d.length){base.makeRequest("../api/update_campaign.php","POST",{campaigns:JSON.stringify(campaignSettings)},function(i){b.removeAttr("disabled");$(base.instances.$detail.$campaign_reminder_dialogue).modal("toggle");view.moduleManagement.campaignReminder=false;view.moduleManagement.saveAllModules();view.moduleManagement.hideSaveChangesButton()});clearInterval(g)}},1000)})}})}})},hideSaveChangesButton:function(){base.actions.manipulation.addClass(base.instances.$detail.$save_changes_hint.id,"hidden");var a=$("#"+base.instances.$detail.$save_modules.id);a.unbind("click")},saveAllModules:function(){view.moduleManagement.saveModuleSettings();var h=$.extend(true,{},view.store.modules.settings);var a=Object.keys(h);for(var e=0;e<Object.keys(h).length;e++){var g=Object.keys(h[a[e]]);for(var f=0;f<Object.keys(g).length;f++){if(typeof(h[a[e]][g[f]])=="string"){h[a[e]][g[f]]=h[a[e]][g[f]].replace("-cache","")}else{h[a[e]][g[f]]=h[a[e]][g[f]]}h[a[e]][g[f]]=base.actions.manipulation.utf8_to_b64(h[a[e]][g[f]])}}var c=[];var b=$("[id^=panel-container-]");for(var d=0;d<b.length;d++){c.push(b[d].id.replace("panel-container-",""))}base.makeRequest("../api/update_modules.php","POST",{account:view.store.account,modules:JSON.stringify({html:btoa(base.instances.$detail.$modules.$container.innerHTML),count:a.length,modules:a,moduleOrder:c}),module_settings:JSON.stringify(h)},function(i){view.moduleManagement.hasChangedSettings=false})},showModuleSettings:function(a){var b=base.instances.$detail.$module_settings;if(view.store.modules.selected.name==a){if(!base.actions.query.hasClass(b.$container.id,"hidden")){view.moduleManagement.closeModuleSettings();return}}if(view.store.modules.settings.hasOwnProperty(view.store.modules.selected.name)){view.moduleManagement.saveModuleSettings()}view.store.modules.selected.name=a;base.actions.manipulation.removeClass(b.$container.id,"hidden");$(".module-highlight").removeClass("module-highlight");base.actions.manipulation.addClass("panel-description-"+a,"module-highlight");base.actions.effects.highlightById(b.$content.id,"white",500);var c=document.getElementById("panel-original-"+a).innerHTML;view.store.modules.selected.originalName=c;if(view.store.modules.settings.hasOwnProperty(view.store.modules.selected.name)&&view.store.modules.settings[view.store.modules.selected.name]){if(view.store.modules.settings[view.store.modules.selected.name].settings){view.moduleManagement.loadModuleSettings()}else{view.moduleManagement.getModuleSettings(c,function(d){view.store.modules.active=view.store.modules.selected;view.store.modules.settings[view.store.modules.selected.name].settings=view.parseForKeywords(d);view.moduleManagement.loadModuleSettings()})}}else{view.moduleManagement.getModuleSettings(c,function(d){view.store.modules.active=view.store.modules.selected;b.$data.innerHTML=view.parseForKeywords(d);view.moduleManagement.saveModuleSettings();view.moduleManagement.onSettingsShown()})}},onSettingsShown:function(){var f=$("[id*=-datetimepicker]");var c=view.store.modules.selected.name;if(f.length>0){f.datetimepicker()}f.on("dp.change",function(){view.moduleManagement.hasChangedSettings=true;view.moduleManagement.showSaveChangesButton()});$("[id*='value']").unbind("change");$("[id*='value']").change(function(){view.moduleManagement.hasChangedSettings=true;view.moduleManagement.showSaveChangesButton()});var e=document.getElementById(c+"-sortable");if(e&&e.innerHTML=="true"){view.store.modules.selected.sortable="yes";var d=$(document.getElementById(c+"-sortable-list"));d.sortable({axis:"y",placeholder:"ui-state-highlight",handle:".panel-heading",items:"li",update:function(){$(".panel",d).each(function(g,j){var i=$(j),h=i.index()});view.moduleManagement.showSaveChangesButton()}})}else{view.store.modules.selected.sortable="no"}var a=base.instances.$detail.$modules.$container.children;for(var b=0;b<a.length;b++){if(a[b].id=="panel-container-"+c){base.instances.$detail.$module_settings.$container.style.marginTop=(b-1)*60}}view.moduleManagement.activateDeleteModuleButton()},closeModuleSettings:function(){var a=base.instances.$detail.$module_settings;if(base.actions.query.hasClass(a.$container.id,"hidden")){return}if(view.store.modules.settings.hasOwnProperty(view.store.modules.selected.name)){view.moduleManagement.saveModuleSettings()}if(view.moduleManagement.hasChangedSettings){view.moduleManagement.showSaveChangesButton()}base.actions.manipulation.addClass(a.$container.id,"hidden");$(".module-highlight").removeClass("module-highlight")},activateModuleBoxes:function(){$moduleBoxes=$(".module-description");if($moduleBoxes.length===0){return}$moduleBoxes.unbind("click");$moduleBoxes.click(function(){view.moduleManagement.showModuleSettings(this.id.replace("panel-description-",""))});$moduleBoxes.popover({container:"body",title:"Click to edit",content:"The settings for this module will appear  on the right.",placement:"right",trigger:"hover"})},getModuleSettings:function(a,b){base.makeRequest("../resource/modules/"+a+"/settings.html","GET",null,b)},activateDeleteModuleButton:function(){var b=$("#"+base.instances.$detail.$module_settings.$deleteModule.id);var a="instance-confirm-delete-module";b.popover({container:"body",title:"Deleting cannot be undone",content:"<input type='button' id='"+a+"' class='btn btn-xs btn-danger' value='Confirm Delete'/>",placement:"left",html:true});b.on("shown.bs.popover",function(){var c=$("#"+a);c.unbind("click");c.click(function(){b.click();document.getElementById("panel-container-"+view.store.modules.selected.name).remove();delete view.store.modules.settings[view.store.modules.selected.name];view.store.modules.selected={name:"",description:"",originalName:""};view.moduleManagement.hasChangedSettings=true;view.moduleManagement.closeModuleSettings();view.moduleManagement.calculateModulesContainerSize()})})},getModuleDataFromStore:function(){view.moduleManagement.activateModuleBoxes();var b=base.instances.$detail.$module_settings.$store.innerHTML;if(b.length===0){return}var f=JSON.parse(atob(base.instances.$detail.$module_settings.$store.innerHTML));var a=Object.keys(f);for(var c=0;c<Object.keys(f).length;c++){var e=Object.keys(f[a[c]]);for(var d=0;d<Object.keys(e).length;d++){f[a[c]][e[d]]=base.actions.manipulation.b64_to_utf8(f[a[c]][e[d]])}f[a[c]].settings=null}view.store.modules.settings=f},calculateModulesContainerSize:function(){var c=base.instances.$detail.$modules;var b=c.$container;var a=0;var f=b.childNodes;var d=0;for(var e=0;e<f.length;e++){if(f[e].tagName=="LI"){d++}}var g=60;b.style.height=(g*d)+"px"},makeModulesSortable:function(){var a=base.instances.$detail.$modules;var b=$("#"+a.$container.id);b.sortable({axis:"y",placeholder:"ui-state-highlight",handle:".panel-heading",items:"li",update:function(){$(".panel",b).each(function(c,f){var e=$(f),d=e.index()});view.moduleManagement.showSaveChangesButton()}})}};